#!/usr/bin/env bash
set -euo pipefail

# Configuration
VPN_DIR="${HOME}/vpn"
VPN_CONFIG="${VPN_DIR}/cmeury-client.ovpn"
#VPN_CONFIG="${VPN_DIR}/cmeury-client-fallback.ovpn"
VPN_ADDITIONS="${VPN_DIR}/vpn-additions.ovpn"
AUTH_TEMPLATE="${VPN_DIR}/auth.txt.template"
ONEPASSWORD_ITEM_ID="gv73rvp5mxx3z6wjdqx3iievj4"

# Check required commands
for cmd in op openvpn expect; do
    command -v "$cmd" &>/dev/null || { echo "Missing required command: $cmd"; exit 1; }
done

# Check required files
for f in "$VPN_CONFIG" "$VPN_ADDITIONS" "$AUTH_TEMPLATE"; do
    [[ -f "$f" ]] || { echo "Missing: $f"; exit 1; }
done

# Create a temporary file and set trap
temp_file=$(mktemp)
trap 'rm -f "$temp_file"' EXIT

# Populate VPN auth file
op inject --in-file "${AUTH_TEMPLATE}" --out-file "${temp_file}" --force

echo ""
echo "+++ Using elevated permissions to create OpenVPN tunnel."
echo ""

# Get OTP token from 1Password first
OTP=$(op item get "${ONEPASSWORD_ITEM_ID}" --otp)

# Use expect to automate OTP entry:
# 1. Spawn openvpn with sudo and auth credentials
# 2. Handle sudo password prompt (if fingerprint fails) without echoing
# 3. Wait for "CHALLENGE: Please enter next token." prompt
# 4. Send the pre-fetched OTP to stdin
# 5. Hand control back to user with 'interact' to keep tunnel running
expect -c "
set timeout -1
spawn sudo openvpn --config ${VPN_CONFIG} --config ${VPN_ADDITIONS} --auth-retry interact --auth-user-pass ${temp_file} --auth-nocache
expect {
    \"*password*\" {
        stty -echo
        interact -o \"\r\" return
        stty echo
        exp_continue
    }
    \"CHALLENGE: Please enter next token.\" {
        send \"${OTP}\r\"
        interact
    }
}
"

