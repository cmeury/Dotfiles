#!/usr/bin/env bash
set -euo pipefail

# Configuration
readonly VPN_DIR="${HOME}/vpn"
readonly VPN_CONFIG="${VPN_DIR}/cmeury-client.ovpn"
readonly VPN_ADDITIONS="${VPN_DIR}/vpn-additions.ovpn"
readonly AUTH_TEMPLATE="${VPN_DIR}/auth.txt.template"
readonly ONEPASSWORD_ITEM_ID="gv73rvp5mxx3z6wjdqx3iievj4"

# Check required commands
if ! command -v op &> /dev/null
then
    echo "!!! 1Password CLI could not be found. See: https://developer.1password.com/docs/cli/get-started"
    exit 1
fi

if ! command -v openvpn &> /dev/null
then
    echo "!!! openvpn command could not be found."
    exit 1
fi

if ! command -v expect &> /dev/null
then
    echo "!!! expect command could not be found. Install with: sudo apt-get install expect"
    exit 1
fi

# Create a temporary file and set trap
temp_file=$(mktemp)
trap 'rm -f "$temp_file"' EXIT

# Populate VPN auth file
op inject --in-file "${AUTH_TEMPLATE}" --out-file "${temp_file}" --force

echo ""
echo "+++ Using elevated permissions to create OpenVPN tunnel."
echo ""

# Get OTP token from 1Password first
OTP=$(op item get "${ONEPASSWORD_ITEM_ID}" --otp)

# Use expect to automate OTP entry:
# 1. Spawn openvpn with sudo and auth credentials
# 2. Handle sudo password prompt (if fingerprint fails) without echoing
# 3. Wait for "CHALLENGE: Please enter next token." prompt
# 4. Send the pre-fetched OTP to stdin
# 5. Hand control back to user with 'interact' to keep tunnel running
expect -c "
set timeout -1
spawn sudo openvpn --config ${VPN_CONFIG} --config ${VPN_ADDITIONS} --auth-retry interact --auth-user-pass ${temp_file} --auth-nocache
expect {
    \"*password*\" {
        stty -echo
        interact -o \"\r\" return
        stty echo
        exp_continue
    }
    \"CHALLENGE: Please enter next token.\" {
        send \"${OTP}\r\"
        interact
    }
}
"

